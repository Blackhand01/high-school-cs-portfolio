#include<stdio.h>
#include<stdlib.h>
#include<windows.h>
#include<conio2.h>
#include<string.h>
#include<ctype.h>
int cornice();
int riga, colonna;
int main() {
	FILE *file;
	int verifica_data(int g, int m, int a);
	int const ds=30, db=100, freccia=175;
	int pick, x, y, invio, i, j, ls, inserito=0, G, M, A, N, c, esistente=0, errore, donna, consonanti, trovato, v, tot;
	char campo[ds], riga[db], codice[17], scelta, risp, *ris, sesso, nome[ds], cognome[ds];
	SetConsoleTitle("Codice fiscale ~ Powered by Montanaro&Paone");
	pick=0;
	do {
		pick=0;
		do {
		    cornice();
			gotoxy(35,5);
			printf("Codice Fiscale");
			gotoxy(23,13);
			printf("1. Acquisizione dati");
			gotoxy(23,14);
			printf("2. Visualizzazione del codice fiscale");
			gotoxy(23,15);
			printf("3. Esci");
			gotoxy(50,17);
			printf("Scegli --> _");
			gotoxy(61,17);
			fflush(stdin);
			scanf("%d", &pick);
		} while(pick<1 || pick>3);
		switch(pick) {
			case 1: {
				cornice();
				do {
					gotoxy(3,3);
					printf("Cognome: _                                   ");
					gotoxy(12,3);
					fflush(stdin);
					gets(campo);
					ls=strlen(campo);
					for(errore=0,i=0; i<ls; i++) {
						campo[i]=toupper(campo[i]);
						if((campo[i]<'A' || campo[i]>'Z') && campo[i]!=' ') errore=1;
					}
				} while(errore==1 || ls==0);
				strcpy(cognome,campo);
				for(i=0,j=0; i<ls; i++) {
					if(campo[i]!=' ') {
						campo[j]=campo[i];
						j++;
					}
				}
				campo[j]='\0';
				ls=strlen(campo);
				for(c=0,i=0; i<ls; i++) {
					if((campo[i]>'A' && campo[i]<='Z') && (campo[i]!='E' && campo[i]!='I' && campo[i]!='O' && campo[i]!='U') && c<3) {
						codice[c]=campo[i];
						c++;
					}
				}
				for(i=0; i<ls; i++) {
					if((campo[i]=='A' || campo[i]=='E' || campo[i]=='I' || campo[i]=='O' || campo[i]=='U') && c<3) {
						codice[c]=campo[i];
						c++;
					}
				}
				if(ls<3) {
					while(c<3) {
						codice[c]='X';
						c++;
					}
				}
				do {
					gotoxy(3,5);
					printf("Nome: _                                      ");
					gotoxy(9,5);
					fflush(stdin);
					gets(campo);
					ls=strlen(campo);
					for(errore=0,i=0; i<ls; i++) {
						campo[i]=toupper(campo[i]);
						if((campo[i]<'A' || campo[i]>'Z') && campo[i]!=' ') errore=1;
					}
				} while(errore==1 || ls==0);
				strcpy(nome,campo);
				for(i=0,j=0; i<ls; i++) {
					if(campo[i]!=' ') {
						campo[j]=campo[i];
						j++;
					}
				}
				campo[j]='\0';
				ls=strlen(campo);
				for(consonanti=0,i=0; i<ls; i++) {
					if((campo[i]>'A' && campo[i]<='Z') && (campo[i]!='E' && campo[i]!='I' && campo[i]!='O' && campo[i]!='U')) consonanti++;
				}
				if(consonanti>=4) {
					consonanti=1;
					for(i=0; i<ls; i++) {
						if((campo[i]>'A' && campo[i]<='Z') && (campo[i]!='E' && campo[i]!='I' && campo[i]!='O' && campo[i]!='U') && consonanti!=2 && c<6) {
							codice[c]=campo[i];
							c++;
						}
						if((campo[i]>'A' && campo[i]<='Z') && (campo[i]!='E' && campo[i]!='I' && campo[i]!='O' && campo[i]!='U')) consonanti++;
					}
				} else {
					for(i=0; i<ls; i++) {
						if((campo[i]>'A' && campo[i]<='Z') && (campo[i]!='E' && campo[i]!='I' && campo[i]!='O' && campo[i]!='U') && c<6) {
							codice[c]=campo[i];
							c++;
						}
					}
					for(i=0; i<ls; i++) {
						if((campo[i]=='A' || campo[i]=='E' || campo[i]=='I' || campo[i]=='O' || campo[i]=='U') && c<6) {
							codice[c]=campo[i];
							c++;
						}
					}
					if(ls<3) {
						while(c<6) {
							codice[c]='X';
							c++;
						}
					}
				}
				do {
					gotoxy(3,7);
					printf("Sesso(M/F): _              ");
					errore=0;
					gotoxy(15,7);
					fflush(stdin);
					gets(campo);
					ls=strlen(campo);
					if(ls>1) errore=1;
					for(i=0; i<ls; i++) {
						campo[i]=toupper(campo[i]);
						if(campo[i]<'A' || campo[i]>'Z') errore=1;
					}
					if(campo[0]!='M' && campo[0]!='F') errore=1;
				} while(errore==1);
				if(campo[0]=='F') {
					donna=1;
					sesso='F';
				} else {
					donna=0;
					sesso='M';
				}
				do {
					gotoxy(3,9);
					printf("Data di nascita(gg/mm/aaaa): ../../....                          ");
					do {
						x=32;
						gotoxy(32,9);
						printf("../../....                                     ");
						gotoxy(x,9);
						scanf("%d",&G);
						if(G>0 && G<10) x--;
						if(G>=1 && G<=31) x=x+3;
					} while(G<1 || G>31);
					do {
						gotoxy(32,9);
						printf("%d/../....                                 ",G);
						gotoxy(x,9);
						scanf("%d",&M);
						if(M>0 && M<10) x--;
						if(M>=1 && M<=12) x=x+3;
					} while(M<1 || M>12);
					do {
						gotoxy(32,9);
						printf("%d/%d/....                                ",G,M);
						gotoxy(x,9);
						scanf("%d",&A);
					} while(A<1500 || A>2500);
					esistente=verifica_data(G,M,A);
				} while(esistente==0);
				N=((A%1000)%100)/10;
				switch(N) {
					case 0: {
						codice[c]='0';
					}
					break;
					case 1: {
						codice[c]='1';
					}
					break;
					case 2: {
						codice[c]='2';
					}
					break;
					case 3: {
						codice[c]='3';
					}
					break;
					case 4: {
						codice[c]='4';
					}
					break;
					case 5: {
						codice[c]='5';
					}
					break;
					case 6: {
						codice[c]='6';
					}
					break;
					case 7: {
						codice[c]='7';
					}
					break;
					case 8: {
						codice[c]='8';
					}
					break;
					case 9: {
						codice[c]='9';
					}
					break;
				}
				c++;
				N=A%10;
				switch(N) {
					case 0: {
						codice[c]='0';
					}
					break;
					case 1: {
						codice[c]='1';
					}
					break;
					case 2: {
						codice[c]='2';
					}
					break;
					case 3: {
						codice[c]='3';
					}
					break;
					case 4: {
						codice[c]='4';
					}
					break;
					case 5: {
						codice[c]='5';
					}
					break;
					case 6: {
						codice[c]='6';
					}
					break;
					case 7: {
						codice[c]='7';
					}
					break;
					case 8: {
						codice[c]='8';
					}
					break;
					case 9: {
						codice[c]='9';
					}
					break;
				}
				c++;
				switch(M) {
					case 1: {
						codice[c]='A';
					}
					break;
					case 2: {
						codice[c]='B';
					}
					break;
					case 3: {
						codice[c]='C';
					}
					break;
					case 4: {
						codice[c]='D';
					}
					break;
					case 5: {
						codice[c]='E';
					}
					break;
					case 6: {
						codice[c]='H';
					}
					break;
					case 7: {
						codice[c]='L';
					}
					break;
					case 8: {
						codice[c]='M';
					}
					break;
					case 9: {
						codice[c]='P';
					}
					break;
					case 10: {
						codice[c]='R';
					}
					break;
					case 11: {
						codice[c]='S';
					}
					break;
					case 12: {
						codice[c]='T';
					}
					break;
				}
				if(donna==1) G=G+40;
				c++;
				N=G/10;
				switch(N) {
					case 0: {
						codice[c]='0';
					}
					break;
					case 1: {
						codice[c]='1';
					}
					break;
					case 2: {
						codice[c]='2';
					}
					break;
					case 3: {
						codice[c]='3';
					}
					break;
					case 4: {
						codice[c]='4';
					}
					break;
					case 5: {
						codice[c]='5';
					}
					break;
					case 6: {
						codice[c]='6';
					}
					break;
					case 7: {
						codice[c]='7';
					}
					break;
					case 8: {
						codice[c]='8';
					}
					break;
					case 9: {
						codice[c]='9';
					}
					break;
				}
				c++;
				N=G%10;
				switch(N) {
					case 0: {
						codice[c]='0';
					}
					break;
					case 1: {
						codice[c]='1';
					}
					break;
					case 2: {
						codice[c]='2';
					}
					break;
					case 3: {
						codice[c]='3';
					}
					break;
					case 4: {
						codice[c]='4';
					}
					break;
					case 5: {
						codice[c]='5';
					}
					break;
					case 6: {
						codice[c]='6';
					}
					break;
					case 7: {
						codice[c]='7';
					}
					break;
					case 8: {
						codice[c]='8';
					}
					break;
					case 9: {
						codice[c]='9';
					}
					break;
				}
				do {
					do {
						gotoxy(3,11);
						printf("Luogo di nascita: _                               ");
						gotoxy(21,11);
						fflush(stdin);
						gets(campo);
						ls=strlen(campo);
						for(errore=0,i=0; i<ls; i++) {
							campo[i]=toupper(campo[i]);
							if((campo[i]<'A' || campo[i]>'Z') && campo[i]!=' ') errore=1;
						}
					} while(errore==1 || ls==0);
					file=fopen("24.ComuniCodiceFiscale.txt","r");
					c=11;
					trovato=0;
					while(trovato==0) {
						ris=fgets(riga, db, file);
						if( ris==NULL ) break;
						ls=strlen(riga);
						ls--;
						riga[ls]='\0';
						for(i=0; i<ls-5; i++) {
							trovato=1;
							if(riga[i]!=campo[i]) trovato=0;
							if(riga[i]!=campo[i]) break;
						}
					}
					if(trovato==1) {
						while(c<15) {
							i++;
							codice[c]=riga[i];
							c++;
						}
					}
					fclose(file);
				} while(trovato==0);
				tot=0;
				for(i=0; i<15; i=i+2) {
					switch(codice[i]) {
						case '0': {
							v=1;
						}
						break;
						case '1': {
							v=0;
						}
						break;
						case '2': {
							v=5;
						}
						break;
						case '3': {
							v=7;
						}
						break;
						case '4': {
							v=9;
						}
						break;
						case '5': {
							v=13;
						}
						break;
						case '6': {
							v=15;
						}
						break;
						case '7': {
							v=17;
						}
						break;
						case '8': {
							v=19;
						}
						break;
						case '9': {
							v=21;
						}
						break;
						case 'A': {
							v=1;
						}
						break;
						case 'B': {
							v=0;
						}
						break;
						case 'C': {
							v=5;
						}
						break;
						case 'D': {
							v=7;
						}
						break;
						case 'E': {
							v=9;
						}
						break;
						case 'F': {
							v=13;
						}
						break;
						case 'G': {
							v=15;
						}
						break;
						case 'H': {
							v=17;
						}
						break;
						case 'I': {
							v=19;
						}
						break;
						case 'J': {
							v=21;
						}
						break;
						case 'K': {
							v=2;
						}
						break;
						case 'L': {
							v=4;
						}
						break;
						case 'M': {
							v=18;
						}
						break;
						case 'N': {
							v=20;
						}
						break;
						case 'O': {
							v=11;
						}
						break;
						case 'P': {
							v=3;
						}
						break;
						case 'Q': {
							v=6;
						}
						break;
						case 'R': {
							v=8;
						}
						break;
						case 'S': {
							v=12;
						}
						break;
						case 'T': {
							v=14;
						}
						break;
						case 'U': {
							v=16;
						}
						break;
						case 'V': {
							v=10;
						}
						break;
						case 'W': {
							v=22;
						}
						break;
						case 'X': {
							v=25;
						}
						break;
						case 'Y': {
							v=24;
						}
						break;
						case 'Z': {
							v=23;
						}
						break;
					}
					tot=tot+v;
				}
				for(i=1; i<14; i=i+2) {
					switch(codice[i]) {
						case '0': {
							v=0;
						}
						break;
						case '1': {
							v=1;
						}
						break;
						case '2': {
							v=2;
						}
						break;
						case '3': {
							v=3;
						}
						break;
						case '4': {
							v=4;
						}
						break;
						case '5': {
							v=5;
						}
						break;
						case '6': {
							v=6;
						}
						break;
						case '7': {
							v=7;
						}
						break;
						case '8': {
							v=8;
						}
						break;
						case '9': {
							v=9;
						}
						break;
						case 'A': {
							v=0;
						}
						break;
						case 'B': {
							v=1;
						}
						break;
						case 'C': {
							v=2;
						}
						break;
						case 'D': {
							v=3;
						}
						break;
						case 'E': {
							v=4;
						}
						break;
						case 'F': {
							v=5;
						}
						break;
						case 'G': {
							v=6;
						}
						break;
						case 'H': {
							v=7;
						}
						break;
						case 'I': {
							v=8;
						}
						break;
						case 'J': {
							v=9;
						}
						break;
						case 'K': {
							v=10;
						}
						break;
						case 'L': {
							v=11;
						}
						break;
						case 'M': {
							v=12;
						}
						break;
						case 'N': {
							v=13;
						}
						break;
						case 'O': {
							v=14;
						}
						break;
						case 'P': {
							v=15;
						}
						break;
						case 'Q': {
							v=16;
						}
						break;
						case 'R': {
							v=17;
						}
						break;
						case 'S': {
							v=18;
						}
						break;
						case 'T': {
							v=19;
						}
						break;
						case 'U': {
							v=20;
						}
						break;
						case 'V': {
							v=21;
						}
						break;
						case 'W': {
							v=22;
						}
						break;
						case 'X': {
							v=23;
						}
						break;
						case 'Y': {
							v=24;
						}
						break;
						case 'Z': {
							v=25;
						}
						break;
					}
					tot=tot+v;
				}
				v=tot%26;
				switch(v) {
					case 0: {
						codice[c]='A';
					}
					break;
					case 1: {
						codice[c]='B';
					}
					break;
					case 2: {
						codice[c]='C';
					}
					break;
					case 3: {
						codice[c]='D';
					}
					break;
					case 4: {
						codice[c]='E';
					}
					break;
					case 5: {
						codice[c]='F';
					}
					break;
					case 6: {
						codice[c]='G';
					}
					break;
					case 7: {
						codice[c]='H';
					}
					break;
					case 8: {
						codice[c]='I';
					}
					break;
					case 9: {
						codice[c]='J';
					}
					break;
					case 10: {
						codice[c]='K';
					}
					break;
					case 11: {
						codice[c]='L';
					}
					break;
					case 12: {
						codice[c]='M';
					}
					break;
					case 13: {
						codice[c]='N';
					}
					break;
					case 14: {
						codice[c]='O';
					}
					break;
					case 15: {
						codice[c]='P';
					}
					break;
					case 16: {
						codice[c]='Q';
					}
					break;
					case 17: {
						codice[c]='R';
					}
					break;
					case 18: {
						codice[c]='S';
					}
					break;
					case 19: {
						codice[c]='T';
					}
					break;
					case 20: {
						codice[c]='U';
					}
					break;
					case 21: {
						codice[c]='V';
					}
					break;
					case 22: {
						codice[c]='W';
					}
					break;
					case 23: {
						codice[c]='X';
					}
					break;
					case 24: {
						codice[c]='Y';
					}
					break;
					case 25: {
						codice[c]='Z';
					}
					break;
				}
				c++;
				codice[c]='\0';
				inserito=1;
			}
			break;
			case 2: {
				cornice();
				if(inserito==0) {
					gotoxy(25,12);
					printf("Prima inserire i dati utente!");
					getch();
				} else {
					gotoxy(27,2);
					printf("I tuoi dati sono:");
					gotoxy(27,4);
					printf("Cognome: %s",cognome);
					gotoxy(27,6);
					printf("Nome: %s",nome);
					gotoxy(27,8);
					printf("Sesso: %c",sesso);
					gotoxy(27,10);
					if(donna==1){
						G=G-40;
						printf("Data di nascita: %d/%d/%d",G,M,A);
					}else{
					printf("Data di nascita: %d/%d/%d",G,M,A);
					}	
					gotoxy(27,12);
					printf("Luogo di nascita: %s",campo);
					gotoxy(21,14);
					printf("Il tuo codice fiscale risulta essere:");
					gotoxy(32,16);
					printf("%s",codice);
					getch();
				}
			}
			break;
			case 3: {
				do {
					cornice();
					textcolor(15);
					gotoxy(25,4);
					printf("Vuoi davvero uscire? (S/N) _");
					fflush(stdin);
					gotoxy(52,4);
					scanf("%c", &risp);
				} while(risp!='s' && risp!='S' && risp!='n' && risp!='N');
				if(risp=='n' || risp=='N') y=12;
			}
			break;
		}
	} while(pick!=3);
}

int verifica_data(int g, int m, int a) {
	int valida=1, gf=28;
	if((m==4 || m==6 || m==9 || m==11) && g>30) valida=0;
	else {
		if(m==2) {
			if(a%400==0 || (a%100!=0 && a%4==0)) gf=29;
			if(g>gf) valida=0;
		}
	}
	return valida;
}

int cornice() {
	int b1=187, b2=200, b3=205, b4=186;
	riga=2;
	colonna=2;
	system("cls");
	textcolor(9);
	gotoxy(80,1);
	printf("%c", b1);
	gotoxy(80,25);
	printf("%c", b1+1);
	gotoxy(1,25);
	printf("%c", b2);
	gotoxy(1,1);
	printf("%c", b2+1);
	do {
		gotoxy(colonna,1);
		printf("%c", b3);
		gotoxy(colonna,25);
		printf("%c", b3);
		colonna=colonna+1;
	} while(colonna!=80);
	do {
		gotoxy(1,riga);
		printf("%c", b4);
		gotoxy(80,riga);
		printf("%c", b4);
		riga=riga+1;
	} while(riga!=25);
	textcolor(15);
}
